<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>

<script>
  // Prevent forms from submitting.
  function preventFormSubmit() {
    var forms = document.querySelectorAll('form');
    for (var i = 0; i < forms.length; i++) {
      forms[i].addEventListener('submit', function(event) {
      event.preventDefault();
      });
    }
  }
  window.addEventListener("load", functionInit, true); 
  
  //INITIALIZE FUNCTIONS ONLOAD
  function functionInit(){
    $('#spinnerModal').modal('show');  
    preventFormSubmit();
    getLastTenRows();
    createGradeDropdown();
    createUnidadDropdown();
  };  

//RETORNA EL LISTADO DE GRADOS DE LA HOJA
  function createGradeDropdown() {
      google.script.run.withSuccessHandler(gradeDropDown).getGradeList();
  }

  //RETORNA EL LISTADO DE UNIDADES DE LA HOJA
  function createUnidadDropdown() {
      google.script.run.withSuccessHandler(unidadDropDown).getUnidadeList();
  }
  

  //UNIDADES MILITARES DROPDOWNS
  function unidadDropDown(values) { //Ref: https://stackoverflow.com/a/53771955/2391195
    var list = document.getElementById('unidad');   
    for (var i = 0; i < values.length; i++) {
      var option = document.createElement("option");
      option.value = values[i];
      option.text = values[i];
      list.appendChild(option);
    }
  }     
  
  //HANDLE FORM SUBMISSION
  function handleFormSubmit(formObject) {
    $('#spinnerModal').modal('show');
    google.script.run.withSuccessHandler(createTable).processForm(formObject);
    document.getElementById("ProductDetails").reset();
  }
  
  function deleteRecord(el) {
    const result = confirm("Desea eliminar el registro?");
    if (!result) return;
      $('#spinnerModal').modal('show');
      const recordId = el.getAttribute('data-id');
      google.script.run.withSuccessHandler(createTable).deleteRecord(recordId);
      document.getElementById("ProductDetails").reset();
    
  }

  
  //GET LAST 10 ROWS
  function getLastTenRows (){
   google.script.run.withSuccessHandler(createTable).getLastTenRecords();
  }

  function editRecord(el){
    $('#spinnerModal').modal('show');
    const id = el.getAttribute('data-id');
    google.script.run.withSuccessHandler(populateForm).getRecordById(id);
  }

  function populateForm(data){
    $('#spinnerModal').modal('hide');
    document.getElementById('recId').value = data[0][0];
    document.getElementById('proceso').value = data[0][1];
    document.getElementById('tipoPMP').value = data[0][2];
    document.getElementById('gradoMilitar').value = data[0][3];
    document.getElementById('funcion').value = data[0][4];
    document.getElementById('unidad').value = data[0][5];
    document.getElementById('documento').value = data[0][6];
    document.getElementById('sexo').value = data[0][7];
    document.getElementById('fecha_doc').value = data[0][8];
    document.getElementById('autoridad').value = data[0][9];
    document.getElementById('nombre_req').value = data[0][10];
    document.getElementById('clasificacion').value = data[0][11];
    document.getElementById('cantidadPMP').value = data[0][12];
    document.getElementById('estado').value = data[0][13];
    document.getElementById('observ_justif').value = data[0][14];
    document.getElementById("message").innerHTML = "<div style='text-align: center' class='alert alert-primary' role='alert'>Registro en Actualización [UNIDAD: "+data[0][5]+"]</div>";
  }

  //CREAR LA TABLA DE DATOS
  function createTable(dataArray) {
  $('#spinnerModal').modal('hide');

  const div = document.getElementById("dataTable");
  if (!(dataArray && dataArray.length)) {
    div.innerHTML = "<div class='alert alert-warning mb-0'>No se encontraron datos.</div>";
    document.getElementById("resultados").innerText = "0";
    return;
  }

  let num;
  let result = `
    <table class="table table-hover table-striped table-sm table-fixed" style="font-size:0.86em">
      <thead>
        <tr>
          <th style="width:30px">#</th>
          <th class="col-actions">Acciones</th>
          <th style="display:none;">ID</th>
          <th style="display:none;">Proceso</th>
          <th style="display:none;">Tipo</th>
          <th>Grado</th>
          <th class="col-funcion">Función</th>
          <th class="col-unidad">Unidad</th>
          <th>Documento</th>
          <th>Sexo</th>
          <th>Fecha Doc</th>
          <th>Autoridad</th>
          <th class="col-nombre">Nombre</th>
          <th>Clasificación</th>
          <th>Cant. PMP</th>
          <th>Estado</th>
          <th class="col-observ" style= "width:120px">Observ / Justif</th>
          <th>Última actualización</th>
        </tr>
      </thead>
      <tbody>
  `;

  for (let i = 0; i < dataArray.length; i++) {
    num = i + 1;
    result += `<tr>`;

    // # fila
    result += `<td class="text-center">${num}</td>`;

    // Acciones (usa data-id para no depender de índices de celdas)
    const rowId = dataArray[i][0] || "";
    result += `
      <td class="col-actions">
        <button type="button" class="btn btn-danger btn-sm me-1" data-id="${rowId}" onclick="deleteRecord(this)">
          <i class="bi bi-eraser-fill"></i>
        </button>
        <button type="button" class="btn btn-warning btn-sm" data-id="${rowId}" onclick="editRecord(this)">
          <i class="bi bi-pencil-square"></i>
        </button>
      </td>
    `;

    // Columnas (oculta 0,1,2 como antes; al resto aplica break-anywhere)
    for (let j = 0; j < dataArray[i].length; j++) {
      const val = dataArray[i][j] ?? "";
        if (j === 0 || j === 1 || j === 2) {
          result += `<td style="display:none;">${esc(val)}</td>`;
        } else {
          result += `<td class="break-anywhere">${esc(val)}</td>`;
        }
    }

    result += `</tr>`;
  }

  result += `
      </tbody>
    </table>
  `;

  div.innerHTML = result;
  document.getElementById("message").innerHTML = "";
  document.getElementById("resultados").innerText = String(num);
}

//ESCAPADOR
function esc(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}


//SEARCH RECORDS
function handleSearchForm(formObject) {
  $('#spinnerModal').modal('show');
  google.script.run.withSuccessHandler(createTable).searchRecords(formObject);
  document.getElementById("search-form").reset();
}

function handleLogin(form){
  google.script.run
    .withSuccessHandler(res => {
      if (res && res.ok) {
        sessionStorage.setItem("userEmail", (res.user?.email || form.email.value || "").trim().toLowerCase());
        const url = new URL(window.location.href);
        url.searchParams.set('page', 'index');
        window.top.location.href = url.toString();
      } else {
        showAlert("message", res?.msg || "Usuario o contraseña incorrectos", "danger");
      }
    })
    .loginUser(form.email.value, form.pass.value);
}


function getAllRecords(){
    $('#spinnerModal').modal('show');
    google.script.run.withSuccessHandler(createTable).getAllRecords();
  }
</script>
